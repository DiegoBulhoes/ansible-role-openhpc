---
language: python

# Use the new container infrastructure
sudo: required
services:
  - docker
before_install:
  - sudo apt-get -qq update
install:
  # Ansible pinned, waiting on: https://github.com/ansible/ansible/pull/70919
  - python3 -m pip install ansible==2.9.10
  - python3 -m pip install ansible-lint
  - python3 -m pip install molecule
  - python3 -m pip install docker

  # Check ansible version
  - ansible --version

  # Create ansible.cfg with correct roles_path
  - printf '[defaults]\nroles_path=../' >ansible.cfg

  # Compensate for repo name being different to the role
  - ln -s $(pwd) ../stackhpc.openhpc

env:
  - SCENARIO=test4

script:
  - ansible-playbook tests/test.yml -i tests/inventory --syntax-check
  # Run Ansible lint against the role
  - ansible-lint .
  # Test the custom filters
  - ansible-playbook tests/filter.yml -i tests/inventory -i tests/inventory-mock-groups
  # Run molecule tests
  - molecule test -s $SCENARIO

notifications:
  webhooks: https://galaxy.ansible.com/api/v1/notifications/
